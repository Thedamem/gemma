<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemma Chat | Dark Mode & Vision</title>
    <style>
        :root {
            --bg-main: #121212;
            --bg-panel: #1e1e1e;
            --bg-input: #2d2d2d;
            --text-main: #e0e0e0;
            --text-muted: #9e9e9e;
            --border: #383838;
            --primary: #bb86fc;
            --primary-hover: #9c27b0;
            --user-msg: #2b5278;
            --model-msg: #2d2d2d;
            --danger: #cf6679;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg-main); color: var(--text-main); margin: 0; padding: 0; display: flex; justify-content: center; height: 100vh; }
        
        .container { width: 100%; max-width: 900px; display: flex; flex-direction: column; height: 100vh; }
        
        /* –®–∞–ø–∫–∞ */
        header { background: var(--bg-panel); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        h1 { margin: 0; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .info-btn { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 14px; }
        
        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { display: none; flex: 1; overflow: hidden; padding: 20px; }
        .screen.active { display: flex; flex-direction: column; }
        
        /* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è */
        .setup-box { background: var(--bg-panel); padding: 30px; border-radius: 12px; border: 1px solid var(--border); text-align: center; max-width: 400px; margin: auto; }
        input[type="password"], select, textarea { width: 100%; padding: 12px; margin: 10px 0; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); border-radius: 8px; box-sizing: border-box; font-size: 15px; outline: none; }
        input[type="password"]:focus, textarea:focus { border-color: var(--primary); }
        button { background: var(--primary); color: #000; font-weight: bold; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 15px; transition: 0.2s; }
        button:hover { background: var(--primary-hover); color: #fff; }
        button:disabled { background: var(--border); color: var(--text-muted); cursor: not-allowed; }
        
        /* –ß–∞—Ç */
        #chat-box { flex: 1; overflow-y: auto; padding-right: 10px; display: flex; flex-direction: column; gap: 15px; margin-bottom: 15px; }
        #chat-box::-webkit-scrollbar { width: 8px; }
        #chat-box::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        
        .message { padding: 15px; border-radius: 12px; max-width: 85%; word-wrap: break-word; line-height: 1.5; }
        .message.user { background: var(--user-msg); align-self: flex-end; border-bottom-right-radius: 2px; }
        .message.model { background: var(--model-msg); align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid var(--border); }
        .message img, .message video { max-width: 100%; max-height: 300px; border-radius: 8px; margin-bottom: 10px; display: block; }
        
        /* –ó–æ–Ω–∞ –≤–≤–æ–¥–∞ */
        .input-area { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; padding: 10px; display: flex; flex-direction: column; }
        .preview-area { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 5px; }
        .preview-item { position: relative; max-width: 100px; max-height: 100px; border-radius: 6px; overflow: hidden; border: 1px solid var(--border); }
        .preview-item img, .preview-item video { width: 100%; height: 100%; object-fit: cover; }
        .preview-item .remove { position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.7); color: white; border-radius: 50%; cursor: pointer; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; }
        
        .input-row { display: flex; gap: 10px; align-items: flex-end; }
        textarea { margin: 0; resize: none; background: transparent; border: none; padding: 10px; max-height: 150px; overflow-y: auto; }
        textarea:focus { border: none; }
        
        .file-label { cursor: pointer; padding: 10px; background: var(--bg-input); border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .file-label:hover { background: var(--border); }
        .file-label svg { width: 24px; height: 24px; fill: var(--text-main); }
        input[type="file"] { display: none; }
        
        .error { color: var(--danger); font-size: 14px; text-align: center; margin-top: 10px; }
        .logout-btn { background: var(--danger); color: white; padding: 8px 15px; }
        .logout-btn:hover { background: #b71c1c; }

        /* –ò–Ω—Ñ–æ –ø–∞–Ω–µ–ª—å */
        #info-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; z-index: 100; }
        .modal-content { background: var(--bg-panel); padding: 25px; border-radius: 12px; max-width: 500px; border: 1px solid var(--border); }
        .modal-content ul { padding-left: 20px; color: var(--text-muted); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üåü Gemma AI</h1>
        <div style="display: flex; gap: 10px;">
            <button class="info-btn" onclick="document.getElementById('info-modal').style.display='flex'">–°–ø—Ä–∞–≤–∫–∞</button>
            <button id="logout-btn" class="logout-btn" style="display: none;" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
    </header>

    <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="setup-screen" class="screen active">
        <div class="setup-box">
            <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
            <p style="color: var(--text-muted); font-size: 14px;">–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á –æ—Ç Google AI Studio.</p>
            <input type="password" id="api-key-input" placeholder="AIzaSy...">
            <button id="connect-btn" onclick="connect()" style="width: 100%; margin-top: 10px;">–í–æ–π—Ç–∏</button>
            <p id="setup-error" class="error"></p>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —á–∞—Ç–∞ -->
    <div id="chat-screen" class="screen">
        <select id="model-select" style="margin-bottom: 15px; background: var(--bg-panel);"></select>
        
        <div id="chat-box"></div>
        
        <div class="input-area">
            <div id="preview-area" class="preview-area"></div>
            <div class="input-row">
                <label class="file-label" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ">
                    <input type="file" id="file-input" accept="image/*, video/mp4, video/webm" onchange="handleFileSelect(event)">
                    <svg viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4s-4 1.79-4 4v12.5c0 3.31 2.69 6 6 6s6-2.69 6-6V6h-1.5z"/></svg>
                </label>
                <textarea id="message-input" rows="1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                <button id="send-btn" onclick="sendMessage()">‚û§</button>
            </div>
        </div>
        <p id="chat-error" class="error"></p>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="info-modal" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-content">
        <h2 style="margin-top:0">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –ª–∏–º–∏—Ç—ã</h2>
        <ul>
            <li><strong>Gemma 3</strong> –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ç–æ –∏ –∫–æ—Ä–æ—Ç–∫–∏–µ –≤–∏–¥–µ–æ (–ú—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ—Å—Ç—å). –°—Ç–∞—Ä—ã–µ –º–æ–¥–µ–ª–∏ (Gemma 2) –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç.</li>
            <li><strong>–õ–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞:</strong> 20 –ú–ë. –≠—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ (inlineData) Google API.</li>
            <li>–í–∞—à API-–∫–ª—é—á –∏ –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ.</li>
            <li>–û—Ç–ø—Ä–∞–≤–∫–∞ –±–æ–ª—å—à–∏—Ö –≤–∏–¥–µ–æ—Ñ–∞–π–ª–æ–≤ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.</li>
        </ul>
        <button onclick="document.getElementById('info-modal').style.display='none'" style="width: 100%">–ü–æ–Ω—è—Ç–Ω–æ</button>
    </div>
</div>

<script>
    const API_BASE = 'https://generativelanguage.googleapis.com/v1beta';
    let currentApiKey = '';
    let chatHistory = []; 
    let selectedFile = null; // –•—Ä–∞–Ω–∏—Ç { mimeType, dataUrl (–¥–ª—è –ø—Ä–µ–≤—å—é), base64 (–¥–ª—è API) }

    // --- –ö—É–∫–∏ ---
    function setCookie(name, value, days) {
        let date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        document.cookie = name + "=" + (value || "")  + "; expires=" + date.toUTCString() + "; path=/; SameSite=Strict";
    }
    function getCookie(name) {
        let ca = document.cookie.split(';');
        for(let i=0; i < ca.length; i++) {
            let c = ca[i].trim();
            if (c.indexOf(name + "=") == 0) return c.substring(name.length + 1, c.length);
        }
        return null;
    }

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    window.onload = () => {
        const savedKey = getCookie('gemma_api_key');
        if (savedKey) {
            document.getElementById('api-key-input').value = savedKey;
            connect(); 
        }
    };

    function logout() {
        setCookie('gemma_api_key', '', -1);
        document.getElementById('setup-screen').classList.add('active');
        document.getElementById('chat-screen').classList.remove('active');
        document.getElementById('logout-btn').style.display = 'none';
        document.getElementById('api-key-input').value = '';
        chatHistory = [];
        document.getElementById('chat-box').innerHTML = '';
        removeFile();
    }

    // --- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ ---
    async function connect() {
        const keyInput = document.getElementById('api-key-input').value.trim();
        const errorEl = document.getElementById('setup-error');
        const btn = document.getElementById('connect-btn');
        
        if (!keyInput) { errorEl.innerText = "–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á."; return; }

        errorEl.innerText = "";
        btn.disabled = true;
        btn.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";

        try {
            const response = await fetch(`${API_BASE}/models?key=${keyInput}`);
            if (!response.ok) throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á –∏–ª–∏ —Å–±–æ–π —Å–µ—Ç–∏.");
            
            const data = await response.json();
            const gemmaModels = data.models.filter(m => 
                m.name.toLowerCase().includes('gemma') && 
                m.supportedGenerationMethods.includes('generateContent')
            );

            if (gemmaModels.length === 0) throw new Error("–ú–æ–¥–µ–ª–∏ Gemma –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.");

            const selectEl = document.getElementById('model-select');
            selectEl.innerHTML = '';
            gemmaModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.innerText = (model.displayName || model.name.split('/')[1]) + (model.name.includes('gemma-3') ? ' (–§–æ—Ç–æ+–í–∏–¥–µ–æ)' : ' (–¢–µ–∫—Å—Ç)');
                selectEl.appendChild(option);
            });

            currentApiKey = keyInput;
            setCookie('gemma_api_key', currentApiKey, 30);
            
            document.getElementById('setup-screen').classList.remove('active');
            document.getElementById('chat-screen').classList.add('active');
            document.getElementById('logout-btn').style.display = 'block';
            
            if(chatHistory.length === 0) {
                addMessageToChat('–°–∏—Å—Ç–µ–º–∞', '–£—Å–ø–µ—à–Ω–æ! –ú–æ–¥–µ–ª–∏ Gemma 3 –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç —Ä–∞–±–æ—Ç—É —Å —Ñ–æ—Ç–æ –∏ –≤–∏–¥–µ–æ. –ü—Ä–æ—Å—Ç–æ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª.', 'model');
            }
        } catch (err) {
            errorEl.innerText = err.message;
        } finally {
            btn.disabled = false;
            btn.innerText = "–í–æ–π—Ç–∏";
        }
    }

    // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ ---
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        // –õ–∏–º–∏—Ç 20 –ú–ë
        if (file.size > 20 * 1024 * 1024) {
            alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 20 –ú–ë.");
            event.target.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const dataUrl = e.target.result;
            const base64 = dataUrl.split(',')[1];
            
            selectedFile = { mimeType: file.type, dataUrl, base64 };
            renderPreview();
        };
        reader.readAsDataURL(file);
    }

    function renderPreview() {
        const previewArea = document.getElementById('preview-area');
        previewArea.innerHTML = '';
        if (!selectedFile) return;

        const div = document.createElement('div');
        div.className = 'preview-item';
        
        let mediaHtml = selectedFile.mimeType.startsWith('video/') 
            ? `<video src="${selectedFile.dataUrl}"></video>` 
            : `<img src="${selectedFile.dataUrl}">`;

        div.innerHTML = `
            ${mediaHtml}
            <div class="remove" onclick="removeFile()">‚úï</div>
        `;
        previewArea.appendChild(div);
    }

    function removeFile() {
        selectedFile = null;
        document.getElementById('file-input').value = '';
        document.getElementById('preview-area').innerHTML = '';
    }

    // --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ---
    async function sendMessage() {
        const inputEl = document.getElementById('message-input');
        const text = inputEl.value.trim();
        const errorEl = document.getElementById('chat-error');
        const sendBtn = document.getElementById('send-btn');
        const modelName = document.getElementById('model-select').value;

        if (!text && !selectedFile) return;

        errorEl.innerText = "";
        inputEl.value = "";
        inputEl.style.height = ''; // –°–±—Ä–æ—Å –≤—ã—Å–æ—Ç—ã
        sendBtn.disabled = true;

        // –§–æ—Ä–º–∏—Ä—É–µ–º —á–∞—Å—Ç–∏ (parts) –¥–ª—è API
        let parts = [];
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ –≤ –∑–∞–ø—Ä–æ—Å
        const currentFile = selectedFile; // –ö—ç—à–∏—Ä—É–µ–º –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
        if (currentFile) {
            parts.push({
                inlineData: { mimeType: currentFile.mimeType, data: currentFile.base64 }
            });
            removeFile(); // –û—á–∏—â–∞–µ–º –ø—Ä–µ–≤—å—é
        }
        
        if (text) {
            parts.push({ text: text });
        }

        addMessageToChat('–í—ã', text, 'user', currentFile);
        chatHistory.push({ role: "user", parts: parts });

        const loadingId = addMessageToChat('Gemma', '...', 'model', null, true);

        try {
            const response = await fetch(`${API_BASE}/${modelName}:generateContent?key=${currentApiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: chatHistory })
            });

            const data = await response.json();
            document.getElementById(loadingId).remove();

            if (!response.ok) {
                // –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ —Ç–µ–∫—Å—Ç–æ–≤—É—é –º–æ–¥–µ–ª—å, API –≤–µ—Ä–Ω–µ—Ç 400 Bad Request
                if(response.status === 400 && currentFile) {
                    throw new Error("–≠—Ç–∞ –º–æ–¥–µ–ª—å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏/–≤–∏–¥–µ–æ. –í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å Gemma 3.");
                }
                throw new Error(data.error?.message || "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏");
            }

            const candidate = data.candidates[0];
            const replyText = candidate.content?.parts[0]?.text || "[–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç]";
            
            addMessageToChat('Gemma', replyText, 'model');
            chatHistory.push({ role: "model", parts: [{ text: replyText }] });

        } catch (err) {
            document.getElementById(loadingId)?.remove();
            errorEl.innerText = "–û—à–∏–±–∫–∞: " + err.message;
            chatHistory.pop(); // –£–¥–∞–ª—è–µ–º —Å–±–æ–π–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
        } finally {
            sendBtn.disabled = false;
            inputEl.focus();
        }
    }

    // --- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —á–∞—Ç–∞ ---
    function addMessageToChat(sender, text, type, fileObj = null, isLoading = false) {
        const chatBox = document.getElementById('chat-box');
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${type}`;
        if (isLoading) msgDiv.id = 'loading-' + Date.now();
        
        let mediaHtml = '';
        if (fileObj) {
            if (fileObj.mimeType.startsWith('image/')) {
                mediaHtml = `<img src="${fileObj.dataUrl}" alt="Attached Image">`;
            } else if (fileObj.mimeType.startsWith('video/')) {
                mediaHtml = `<video src="${fileObj.dataUrl}" controls></video>`;
            }
        }

        const formattedText = text ? text.replace(/\n/g, '<br>') : '';
        msgDiv.innerHTML = `<div style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">${sender}</div>${mediaHtml}${formattedText}`;
        
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
        
        return msgDiv.id;
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter (–±–µ–∑ Shift)
    document.getElementById('message-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
</script>

</body>
</html>
