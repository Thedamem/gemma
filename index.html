<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemma Pro Chat | Markdown & Streaming</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è Markdown –∏ –æ—á–∏—Å—Ç–∫–∏ HTML -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.9/purify.min.js"></script>

    <style>
        :root {
            --bg-main: #121212;
            --bg-panel: #1e1e1e;
            --bg-input: #2d2d2d;
            --text-main: #e0e0e0;
            --text-muted: #9e9e9e;
            --border: #383838;
            --primary: #bb86fc;
            --primary-hover: #9c27b0;
            --user-msg: #2b5278;
            --model-msg: #2d2d2d;
            --danger: #cf6679;
            --code-bg: #000000;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg-main); color: var(--text-main); margin: 0; padding: 0; display: flex; justify-content: center; height: 100vh; }
        .container { width: 100%; max-width: 900px; display: flex; flex-direction: column; height: 100vh; }
        
        header { background: var(--bg-panel); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        h1 { margin: 0; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        .screen { display: none; flex: 1; overflow: hidden; padding: 20px; }
        .screen.active { display: flex; flex-direction: column; }
        
        .setup-box { background: var(--bg-panel); padding: 30px; border-radius: 12px; border: 1px solid var(--border); text-align: center; max-width: 400px; margin: auto; width: 100%;}
        input[type="password"], select, textarea { width: 100%; padding: 12px; margin: 10px 0; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); border-radius: 8px; box-sizing: border-box; font-size: 15px; outline: none; }
        button { background: var(--primary); color: #000; font-weight: bold; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 15px; transition: 0.2s; }
        button:hover { background: var(--primary-hover); color: #fff; }
        button:disabled { background: var(--border); color: var(--text-muted); cursor: not-allowed; }
        .logout-btn { background: var(--danger); color: white; padding: 8px 15px; font-size: 14px;}
        .logout-btn:hover { background: #b71c1c; }
        
        #chat-box { flex: 1; overflow-y: auto; padding-right: 10px; display: flex; flex-direction: column; gap: 15px; margin-bottom: 15px; }
        #chat-box::-webkit-scrollbar { width: 8px; }
        #chat-box::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        
        .message { padding: 15px; border-radius: 12px; max-width: 85%; line-height: 1.5; }
        .message.user { background: var(--user-msg); align-self: flex-end; border-bottom-right-radius: 2px; }
        .message.model { background: var(--model-msg); align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid var(--border); width: 100%;}
        .message img, .message video { max-width: 100%; max-height: 300px; border-radius: 8px; margin-bottom: 10px; display: block; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è Markdown */
        .markdown-body { font-size: 15px; word-wrap: break-word; }
        .markdown-body p { margin: 0 0 10px 0; }
        .markdown-body pre { background: var(--code-bg); padding: 12px; border-radius: 8px; overflow-x: auto; border: 1px solid var(--border); }
        .markdown-body code { font-family: 'Courier New', Courier, monospace; background: var(--code-bg); padding: 2px 5px; border-radius: 4px; font-size: 0.9em; }
        .markdown-body pre code { background: transparent; padding: 0; }
        .markdown-body table { border-collapse: collapse; width: 100%; margin-bottom: 10px; }
        .markdown-body th, .markdown-body td { border: 1px solid var(--border); padding: 8px; text-align: left; }
        .markdown-body th { background: var(--bg-input); }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–≤–µ—Ç–∞ */
        .meta-info { font-size: 11px; color: var(--text-muted); margin-top: 10px; border-top: 1px solid var(--border); padding-top: 8px; display: flex; gap: 15px; flex-wrap: wrap; }
        .meta-info span { display: flex; align-items: center; gap: 4px; }

        /* –ó–æ–Ω–∞ –≤–≤–æ–¥–∞ */
        .input-container { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; padding: 10px; }
        .controls-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 5px; }
        .stream-toggle { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-muted); cursor: pointer; }
        
        .preview-area { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 5px; }
        .preview-item { position: relative; width: 60px; height: 60px; border-radius: 6px; overflow: hidden; border: 1px solid var(--border); }
        .preview-item img, .preview-item video { width: 100%; height: 100%; object-fit: cover; }
        .preview-item .remove { position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.7); color: white; border-radius: 50%; cursor: pointer; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; }
        
        .input-row { display: flex; gap: 10px; align-items: flex-end; }
        textarea { margin: 0; resize: none; background: transparent; border: none; padding: 10px; max-height: 150px; overflow-y: auto; }
        .file-label { cursor: pointer; padding: 10px; background: var(--bg-input); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .file-label svg { width: 24px; height: 24px; fill: var(--text-main); }
        input[type="file"] { display: none; }
        .error { color: var(--danger); font-size: 14px; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üåü Gemma Pro</h1>
        <button id="logout-btn" class="logout-btn" style="display: none;" onclick="logout()">–í—ã–π—Ç–∏</button>
    </header>

    <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="setup-screen" class="screen active">
        <div class="setup-box">
            <h2>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h2>
            <input type="password" id="api-key-input" placeholder="–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á –æ—Ç AI Studio">
            <button id="connect-btn" onclick="connect()" style="width: 100%;">–í–æ–π—Ç–∏</button>
            <p id="setup-error" class="error"></p>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —á–∞—Ç–∞ -->
    <div id="chat-screen" class="screen">
        <select id="model-select" style="margin-bottom: 15px; background: var(--bg-panel);"></select>
        
        <div id="chat-box"></div>
        
        <div class="input-container">
            <div class="controls-row">
                <label class="stream-toggle">
                    <input type="checkbox" id="stream-checkbox" checked>
                    –ü–ª–∞–≤–Ω—ã–π –≤—ã–≤–æ–¥ (–°—Ç—Ä–∏–º)
                </label>
            </div>
            
            <div id="preview-area" class="preview-area"></div>
            
            <div class="input-row">
                <label class="file-label" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ">
                    <input type="file" id="file-input" accept="image/*, video/mp4, video/webm" onchange="handleFileSelect(event)">
                    <svg viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4s-4 1.79-4 4v12.5c0 3.31 2.69 6 6 6s6-2.69 6-6V6h-1.5z"/></svg>
                </label>
                <textarea id="message-input" rows="1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                <button id="send-btn" onclick="sendMessage()">‚û§</button>
            </div>
        </div>
        <p id="chat-error" class="error"></p>
    </div>
</div>

<script>
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Marked.js –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç—Ä–æ–∫
    marked.setOptions({ breaks: true });

    const API_BASE = 'https://generativelanguage.googleapis.com/v1beta';
    let currentApiKey = '';
    let chatHistory = []; 
    let selectedFile = null; 

    // --- –ö—É–∫–∏ ---
    function setCookie(name, value, days) {
        let date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        document.cookie = `${name}=${value || ""}; expires=${date.toUTCString()}; path=/; SameSite=Strict`;
    }
    function getCookie(name) {
        let matches = document.cookie.match(new RegExp("(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"));
        return matches ? decodeURIComponent(matches[1]) : null;
    }

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    window.onload = () => {
        const savedKey = getCookie('gemma_api_key');
        if (savedKey) {
            document.getElementById('api-key-input').value = savedKey;
            connect(); 
        }
    };

    function logout() {
        setCookie('gemma_api_key', '', -1);
        document.getElementById('setup-screen').classList.add('active');
        document.getElementById('chat-screen').classList.remove('active');
        document.getElementById('logout-btn').style.display = 'none';
        document.getElementById('api-key-input').value = '';
        chatHistory = [];
        document.getElementById('chat-box').innerHTML = '';
        removeFile();
    }

    // --- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ ---
    async function connect() {
        const keyInput = document.getElementById('api-key-input').value.trim();
        const errorEl = document.getElementById('setup-error');
        const btn = document.getElementById('connect-btn');
        
        if (!keyInput) return;
        btn.disabled = true; btn.innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...";

        try {
            const response = await fetch(`${API_BASE}/models?key=${keyInput}`);
            if (!response.ok) throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á API.");
            
            const data = await response.json();
            const gemmaModels = data.models.filter(m => m.name.includes('gemma') && m.supportedGenerationMethods.includes('generateContent'));

            if (gemmaModels.length === 0) throw new Error("–ú–æ–¥–µ–ª–∏ Gemma –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.");

            const selectEl = document.getElementById('model-select');
            selectEl.innerHTML = '';
            gemmaModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.innerText = (model.displayName || model.name.split('/')[1]) + (model.name.includes('gemma-3') ? ' (–§–æ—Ç–æ+–í–∏–¥–µ–æ)' : '');
                selectEl.appendChild(option);
            });

            currentApiKey = keyInput;
            setCookie('gemma_api_key', currentApiKey, 30);
            
            document.getElementById('setup-screen').classList.remove('active');
            document.getElementById('chat-screen').classList.add('active');
            document.getElementById('logout-btn').style.display = 'block';
        } catch (err) {
            errorEl.innerText = err.message;
        } finally {
            btn.disabled = false; btn.innerText = "–í–æ–π—Ç–∏";
        }
    }

    // --- –§–∞–π–ª—ã ---
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        if (file.size > 20 * 1024 * 1024) return alert("–ú–∞–∫—Å–∏–º—É–º 20 –ú–ë.");

        const reader = new FileReader();
        reader.onload = (e) => {
            selectedFile = { mimeType: file.type, dataUrl: e.target.result, base64: e.target.result.split(',')[1] };
            renderPreview();
        };
        reader.readAsDataURL(file);
    }

    function renderPreview() {
        const previewArea = document.getElementById('preview-area');
        previewArea.innerHTML = '';
        if (!selectedFile) return;
        const html = selectedFile.mimeType.startsWith('video/') ? `<video src="${selectedFile.dataUrl}"></video>` : `<img src="${selectedFile.dataUrl}">`;
        previewArea.innerHTML = `<div class="preview-item">${html}<div class="remove" onclick="removeFile()">‚úï</div></div>`;
    }

    function removeFile() {
        selectedFile = null;
        document.getElementById('file-input').value = '';
        document.getElementById('preview-area').innerHTML = '';
    }

    // --- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ---
    function buildMetaHtml(timeMs, usage) {
        if (!usage) return '';
        const timeSec = (timeMs / 1000).toFixed(2);
        const tps = (usage.candidatesTokenCount / (timeMs / 1000)).toFixed(1);
        return `
            <div class="meta-info">
                <span>‚è±Ô∏è ${timeSec} —Å–µ–∫.</span>
                <span>‚ö° ${tps} —Ç/—Å</span>
                <span>ü™ô –¢–æ–∫–µ–Ω—ã: ${usage.promptTokenCount} (–≤—Ö–æ–¥) + ${usage.candidatesTokenCount} (–≤—ã—Ö–æ–¥) = ${usage.totalTokenCount}</span>
            </div>
        `;
    }

    // --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ---
    async function sendMessage() {
        const inputEl = document.getElementById('message-input');
        const text = inputEl.value.trim();
        const errorEl = document.getElementById('chat-error');
        const sendBtn = document.getElementById('send-btn');
        const modelName = document.getElementById('model-select').value;
        const useStream = document.getElementById('stream-checkbox').checked;

        if (!text && !selectedFile) return;

        errorEl.innerText = "";
        inputEl.value = "";
        inputEl.style.height = '';
        sendBtn.disabled = true;

        let parts = [];
        const currentFile = selectedFile;
        if (currentFile) {
            parts.push({ inlineData: { mimeType: currentFile.mimeType, data: currentFile.base64 } });
            removeFile();
        }
        if (text) parts.push({ text: text });

        // –†–µ–Ω–¥–µ—Ä–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        addMessageToChat('–í—ã', text, 'user', currentFile);
        chatHistory.push({ role: "user", parts: parts });

        const msgDivId = addMessageToChat('Gemma', useStream ? '‚ñå' : '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...', 'model');
        const contentDiv = document.querySelector(`#${msgDivId} .markdown-body`);
        const msgContainerDiv = document.getElementById(msgDivId);

        const startTime = performance.now();
        let fullResponseText = "";

        try {
            const requestBody = JSON.stringify({ contents: chatHistory });
            
            if (useStream) {
                // –†–ï–ñ–ò–ú –°–¢–†–ò–ú–ò–ù–ì–ê (SSE)
                const response = await fetch(`${API_BASE}/${modelName}:streamGenerateContent?alt=sse&key=${currentApiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: requestBody
                });
                
                if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ API: ${response.status}`);

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let buffer = "";
                let usageMetadata = null;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // –û—Å—Ç–∞–≤–ª—è–µ–º –Ω–µ–ø–æ–ª–Ω—É—é —Å—Ç—Ä–æ–∫—É –≤ –±—É—Ñ–µ—Ä–µ

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.slice(6);
                            if (dataStr === '[DONE]') continue;
                            try {
                                const data = JSON.parse(dataStr);
                                if (data.candidates && data.candidates[0].content) {
                                    fullResponseText += data.candidates[0].content.parts[0].text;
                                    contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText + '‚ñå'));
                                    scrollToBottom();
                                }
                                if (data.usageMetadata) usageMetadata = data.usageMetadata;
                            } catch (e) { console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —á–∞–Ω–∫–∞:", e); }
                        }
                    }
                }
                // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä –±–µ–∑ –∫—É—Ä—Å–æ—Ä–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText));
                const endTime = performance.now();
                if (usageMetadata) msgContainerDiv.innerHTML += buildMetaHtml(endTime - startTime, usageMetadata);

            } else {
                // –†–ï–ñ–ò–ú –ü–û–õ–ù–û–ì–û –û–¢–í–ï–¢–ê
                const response = await fetch(`${API_BASE}/${modelName}:generateContent?key=${currentApiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: requestBody
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏");

                const endTime = performance.now();
                fullResponseText = data.candidates[0].content?.parts[0]?.text || "";
                
                contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(fullResponseText));
                if (data.usageMetadata) msgContainerDiv.innerHTML += buildMetaHtml(endTime - startTime, data.usageMetadata);
            }

            chatHistory.push({ role: "model", parts: [{ text: fullResponseText }] });

        } catch (err) {
            errorEl.innerText = err.message;
            chatHistory.pop(); 
            contentDiv.innerHTML = "<span class='error'>–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</span>";
        } finally {
            sendBtn.disabled = false;
            inputEl.focus();
            scrollToBottom();
        }
    }

    function addMessageToChat(sender, text, type, fileObj = null) {
        const chatBox = document.getElementById('chat-box');
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${type}`;
        msgDiv.id = 'msg-' + Date.now();
        
        let mediaHtml = '';
        if (fileObj) {
            mediaHtml = fileObj.mimeType.startsWith('image/') 
                ? `<img src="${fileObj.dataUrl}">` 
                : `<video src="${fileObj.dataUrl}" controls></video>`;
        }

        // –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—ã–≤–æ–¥–∏–º –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç, –¥–ª—è –º–æ–¥–µ–ª–∏ ‚Äî —á–µ—Ä–µ–∑ Markdown
        let contentHtml = type === 'user' 
            ? `<div style="white-space: pre-wrap;">${text}</div>` 
            : `<div class="markdown-body">${DOMPurify.sanitize(marked.parse(text))}</div>`;

        msgDiv.innerHTML = `
            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">${sender}</div>
            ${mediaHtml}
            ${contentHtml}
        `;
        
        chatBox.appendChild(msgDiv);
        scrollToBottom();
        return msgDiv.id;
    }

    function scrollToBottom() {
        const chatBox = document.getElementById('chat-box');
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    document.getElementById('message-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
</script>

</body>
</html>
